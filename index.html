<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.2" />






<meta name="description" content="一个很会写代码的伪文艺青年">
<meta property="og:type" content="website">
<meta property="og:title" content="暖壶盖儿">
<meta property="og:url" content="http:&#x2F;&#x2F;thinker-lj.github.io&#x2F;index.html">
<meta property="og:site_name" content="暖壶盖儿">
<meta property="og:description" content="一个很会写代码的伪文艺青年">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    }
  };
</script>




  <link rel="canonical" href="http://thinker-lj.github.io/"/>


  <title> 暖壶盖儿 </title>
</head>

<body itemscope itemtype="//schema.org/WebPage" lang="zh-Hans">

  


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-89139845-1', 'auto');
  ga('send', 'pageview');
</script>


  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?733c7768164bf371bb204c415d266f30";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>








  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="//schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">暖壶盖儿</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/Human_Interface_Guidelines/" itemprop="url">
                  iPhone X 刘海儿打理指南
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-09-13T12:10:47+08:00" content="2017-09-13">
              2017-09-13
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/Human_Interface_Guidelines/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="Human_Interface_Guidelines/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
          
只有那些疯狂到以为自己可以改变世界的人，才能改变这个世界。

前言北京时间今天凌晨1点，苹果再一次让全世界沸腾。iPhone X 带给我们的最大改变：全屏 Super Retina显示屏。它提供了更多的内容显示空间，同时也营造了更加深入的沉浸感。作为 iOS 开发者，在为强大的 Face ID 和全面屏欣喜的同时，我更担忧“齐刘海”的适配！ 下面结合官方的人机交互指南，来了解下如何设计 App 才能在iPhone X 和其他所有 iOS 设备上都看起来很棒。

人机交互指南屏幕大小在竖屏下，iPhone X 上的显示的宽度与 iPhone 6，iPhone 7和 iPhone 8的4.7英寸显示屏的宽度保持一致。然而，iPhone X 比4.7英寸显示屏高了145个点，这导致增加了大约20％的垂直高度内容。




Portrait
Landscape




1125px × 2436px (375pt × 812pt @3x)
2436px × 1125px (812pt × 375pt @3x)



布局在 iPhone X 布局中，最关键的是：必须确保布局填满屏幕，同时又不会被设备的圆角，传感器外壳或用于访问主屏幕的指示灯所遮盖。

可喜的是，大多数标准的系统提供的UI元素和控件（如 navigation bars，tables 和 collections）都已经为新外形做了很好的适配。 背景已经延伸到显示器的边缘，并且UI元件被很恰当地插入和定位在安全区域。因此，对于具有自定义布局的 App，支持iPhone X 也应该比较容易，特别是如果使用了 AutoLayout 并遵守安全区域(safe area)和边距布局(margin layout)指南。这些在上文都已经有过较详细的阐述。下面说几点需要特别注意的：

在 iPhone X 上预览 App: 在拿到新机之前，也可以先使用 Simulator 来预览和检查下布局问题。 但是一些依赖硬件的功能，如图像效果和交互体验，最好还是在真机上预览。

始终保持全屏体验: 确保背景延伸到显
          ...

          <div class="post-more-link text-center">
            <a class="btn" href="/Human_Interface_Guidelines/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


      
    
      
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/%E4%B8%BA-iOS-11-%E6%9B%B4%E6%96%B0%E4%BD%A0%E7%9A%84App-WWDC-2017-Session-204/" itemprop="url">
                  为你的 App 适配 iOS 11 - WWDC 2017 Session 204
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-06-27T14:52:48+08:00" content="2017-06-27">
              2017-06-27
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/%E4%B8%BA-iOS-11-%E6%9B%B4%E6%96%B0%E4%BD%A0%E7%9A%84App-WWDC-2017-Session-204/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="为-iOS-11-更新你的App-WWDC-2017-Session-204/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <blockquote>
<p>活着就是为了改变世界，难道还有其他原因吗？ - 史蒂夫·乔布斯</p>
</blockquote>
<p><img src="/images/14985813121759.jpg" alt=""></p>
<h1 id="amp-引子"><a href="#amp-引子" class="headerlink" title="&amp; 引子"></a>&amp; 引子</h1><p><a href="https://developer.apple.com/videos/play/wwdc2017/204/" target="_blank" rel="noopener">想先看原视频的点这里</a> iOS 11 为整个生态系统的 UI 元素带来了一种更加大胆、动态的新风格。 下面一起了解一下如何在应用中采用新功能，包括具有集成了搜索的大标题栏，文字图标横向排列的 tab 以及 Table View 带来的惊喜。 通过进一步了解新的模式和增强功能，来为用户提供更加完美的体验。</p>
<hr>
<h1 id="amp-适配-UIKit’s-Bars带来的新功能"><a href="#amp-适配-UIKit’s-Bars带来的新功能" class="headerlink" title="&amp; 适配 UIKit’s Bars带来的新功能"></a>&amp; 适配 UIKit’s Bars带来的新功能</h1><p>为了完美的用户体验这个终极目标，iOS 和 Android 分别从封闭和开放两个极端不断演化。下图的内容是iOS 11增加的一个文件管理相关的新App，虽然目前功能有限，但有理由相信这又是个乐观的开始。</p>
<p><img src="/images/14984043998211.jpg" alt=""></p>
<p>files 这个App为我们展现了iOS 11在UI方面的新特性：更大的标题（通过向上滑动，可以让标题回到原来的UI 效果），整合的搜索框，以及横屏的状态下底部tab会呈现下图所示的 icon 和 text 左右并排显示的新效果。<br><img src="/images/14984045416076.jpg" alt=""><br>关于 files 还有更多有趣的新特性，因为不在本文的讨论范围内，就留给大家去探索吧！
          <div class="post-more-link text-center">
            <a class="btn" href="/%E4%B8%BA-iOS-11-%E6%9B%B4%E6%96%B0%E4%BD%A0%E7%9A%84App-WWDC-2017-Session-204/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


      
    
      
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/%E8%BF%99%E4%B9%88%E8%BF%91%E9%82%A3%E4%B9%88%E8%BF%9C-%E6%AF%95%E4%B8%9A%E4%B8%A4%E5%91%A8%E5%B9%B4%E5%B0%8F%E8%AE%B0/" itemprop="url">
                  这么近那么远 - 毕业两周年小记
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-06-25T21:10:47+08:00" content="2017-06-25">
              2017-06-25
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/%E8%BF%99%E4%B9%88%E8%BF%91%E9%82%A3%E4%B9%88%E8%BF%9C-%E6%AF%95%E4%B8%9A%E4%B8%A4%E5%91%A8%E5%B9%B4%E5%B0%8F%E8%AE%B0/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="这么近那么远-毕业两周年小记/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p><img src="/images/IMG_0292.jpg" alt=""><br>图片来自图虫 - 一个优质摄影师的社区（工位靠墙上方偶然看到的 惊讶于公司居然还有如此文艺的产品）</p>
<hr>
<script>
    function ishidden(odiv){
        var vdiv = document.getElementById(odiv);
        vdiv.style.display = (vdiv.style.display == 'none')?'block':'none';
    }
</script>

<div onclick="ishidden('X')" style="color: gray; cursor: pointer">这里折叠了一首可以烘托气氛的小诗：</div><div id="X" style="display:none;">
纽约时间比加州时间早三个小时，
New York is 3 hours ahead of California,
但加州时间并没有变慢。
but it does not make California slow. 
有人22岁就毕业了， 
Someone graduated at the age of 22, 
但等了五年才找到好的工作！  
but waited 5 years before securing a good job! 
有人25岁就当上CEO，  
Someone became a CEO at 25,  
却在50岁去世。  
and died at 50.  
也有人迟到50岁才当上CEO，  
While another became a CEO at 50,  
然后活到90岁。  
and lived to 90 years.  
有人依然单身，  
Someone is still single,  
同时也有人已婚。  
while someone else got married.  
奥巴马55岁就退休，  
Obama retires at 55,  
川普70岁才开始当总统。  
but Trump starts at 70.  
世上每个人本来就有自己的发展时区。  
Absolutely everyone in this world works based on their Time Zone.  
身边有些人看似走在你前面，  
People around you might seem to go ahead of you,  
也有人看似走在你后面。  
some might seem to be behind you.  
但其实每个人在自己的时区有自己的步程。  
But everyone is running their own RACE, in their own TIME.  
不用嫉妒或嘲笑他们。  
Don’t envy them or mock them.  
他们都在自己的时区里，你也是！  
They are in their TIME ZONE, and you are in yours!  
生命就是等待正确的行动时机。  
Life is about waiting for the right moment to act.  
所以，放轻松。  
So, RELAX.  
你没有落后。  
You’re not LATE.  
你没有领先。  
You’re not EARLY.  
在命运为你安排的属于自己的时区里，一切都准时。  
You are very much ON TIME, and in your TIME ZONE Destiny set up for you.​​​​  
</div>


<hr>
<p>我会时常问自己一个问题：最近走的快了，还是慢了？每到这个时候，总能感受到内心的浮躁。<br>作为一个走出校门两年的“老码农”，我很幸运，该体验的失败和成功，都经历了。但还是感觉有个目标，跳一跳，能碰到，所以会浮躁……</p>
          <div class="post-more-link text-center">
            <a class="btn" href="/%E8%BF%99%E4%B9%88%E8%BF%91%E9%82%A3%E4%B9%88%E8%BF%9C-%E6%AF%95%E4%B8%9A%E4%B8%A4%E5%91%A8%E5%B9%B4%E5%B0%8F%E8%AE%B0/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


      
    
      
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/Swift%E4%B9%8B%E6%BC%AB%E8%B0%88%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86/" itemprop="url">
                  Swift之漫谈错误处理
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-02-01T19:57:19+08:00" content="2017-02-01">
              2017-02-01
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Swift/" itemprop="url" rel="index">
                    <span itemprop="name">Swift</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/Swift%E4%B9%8B%E6%BC%AB%E8%B0%88%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="Swift之漫谈错误处理/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <blockquote>
<p>一个人知道了自己的短处，能够改过自新，就是幸福的。——莎士比亚</p>
</blockquote>
<hr>
<h1 id="amp-引子"><a href="#amp-引子" class="headerlink" title="&amp; 引子"></a>&amp; 引子</h1><p>代码遇到意外，在所难免，Swift 发展到此时的 3.0 版本，对错误处理机制不断完善，面对不同场景，现在我们已经可以有多种选择。风格依旧，本文依然不是如何进行错误处理的严肃科普文，有这个需求的同学，Google 或者官方文档更适合你。下面，我们就聊聊<strong>错误处理</strong>在 Swift 这门语言中玩出了什么新花样儿…</p>
<hr>
<h1 id="amp-错误与异常"><a href="#amp-错误与异常" class="headerlink" title="&amp; 错误与异常"></a>&amp; 错误与异常</h1><p>先来看下 Objective-C，错误和异常有着明显的区别，这体现在设计之初的本意上。<strong>错误</strong>的范畴大多会归咎于正常情况，只是结果并不符合我们的预期，例如文件读写失败，产生错误的原因可能是磁盘空间不足等等，网络请求失败，产生错误的原因就更复杂了；但是<strong>异常</strong>大多是我们的代码漏洞造成的，对应的处理类是 NSException。<br>我个人并不喜欢二者这种刻意而且明显区别。特别是针对错误，下面这样的例子应该很常见：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSError</span> *error = <span class="literal">nil</span>;</span><br><span class="line"><span class="built_in">BOOL</span> success = [[<span class="built_in">NSFileManager</span> defaultManager] moveItemAtPath:<span class="string">@"/path/to/target"</span></span><br><span class="line">                                                       toPath:<span class="string">@"/path/to/destination"</span></span><br><span class="line">                                                        error:&amp;error];</span><br><span class="line"><span class="keyword">if</span> (!success) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, error);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 更常见的写法</span></span><br><span class="line">[[<span class="built_in">NSFileManager</span> defaultManager] moveItemAtPath:<span class="string">@"/path/to/target"</span></span><br><span class="line">                                                       toPath:<span class="string">@"/path/to/destination"</span></span><br><span class="line">                                                        error:<span class="literal">nil</span>];</span><br></pre></td></tr></table></figure>
<p>是的，正如代码中更常见的写法，我们很容易偷懒绕开错误处理，这明显违背了 API 的设计初衷，也影响了代码的鲁棒性并给后续问题排查带来不便。这在 Swift 中得到了有效改善。
          <div class="post-more-link text-center">
            <a class="btn" href="/Swift%E4%B9%8B%E6%BC%AB%E8%B0%88%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


      
    
      
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/%E6%AD%A4%E5%88%BB%E8%84%91%E6%B5%B7%E9%87%8C%E7%9A%84%E2%80%9C%E7%BB%A7%E5%BE%80%E5%BC%80%E6%9D%A5%E2%80%9D/" itemprop="url">
                  此刻脑海里的“继往开来”（2016年度总结）
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-01-27T23:59:59+08:00" content="2017-01-27">
              2017-01-27
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/%E5%A4%A7%E5%9F%8E%E5%B0%8F%E4%BA%8B/" itemprop="url" rel="index">
                    <span itemprop="name">大城小事</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/%E6%AD%A4%E5%88%BB%E8%84%91%E6%B5%B7%E9%87%8C%E7%9A%84%E2%80%9C%E7%BB%A7%E5%BE%80%E5%BC%80%E6%9D%A5%E2%80%9D/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="此刻脑海里的“继往开来”/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p><img src="/images/yesterday.jpg" alt=""><br>图片来自朋友圈，阳光下这四棵树，触到了内心最温暖的地方…</p>
<hr>
<blockquote>
<p>我相信上苍一切的安排，也相信生命的纯良与温润…</p>
</blockquote>
<hr>
<h1 id="amp-写在前面"><a href="#amp-写在前面" class="headerlink" title="&amp; 写在前面"></a>&amp; 写在前面</h1><p>我始终觉得，除夕夜才适合写个人年度总结。<br>站在这个时间点上，过往喜忧，都会被冲淡些，方便更加客观的审视自己。<br>我不好意思也不愿意，把今年自己的表现定义为“空前绝后”。<br>春晚作为背景音乐的此刻，感觉称作“继往开来”，能更加贴合氛围，也带来些许希望…</p>
<hr>
<h1 id="amp-发现更小的自己"><a href="#amp-发现更小的自己" class="headerlink" title="&amp; 发现更小的自己"></a>&amp; 发现更小的自己</h1><p>工位上落满了灰尘，五分钟就可以擦干净了；<br>有时在想，在这个开放式大环境里，有多少是我可以轻松驾驭和影响的？<br>这一年，有过挣扎、有过迷茫、有过膨胀…<br>《人类简史》让我想明白了，连整个人类发展史都是上苍打个盹的时间罢了…<br>我的存在，原来只不过是个偶然！
          <div class="post-more-link text-center">
            <a class="btn" href="/%E6%AD%A4%E5%88%BB%E8%84%91%E6%B5%B7%E9%87%8C%E7%9A%84%E2%80%9C%E7%BB%A7%E5%BE%80%E5%BC%80%E6%9D%A5%E2%80%9D/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


      
    
      
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/%E4%BB%8EBlocksKit%E7%9C%8B%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/" itemprop="url">
                  从BlocksKit看动态代理
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-01-22T14:24:52+08:00" content="2017-01-22">
              2017-01-22
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/" itemprop="url" rel="index">
                    <span itemprop="name">源码解析</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/%E4%BB%8EBlocksKit%E7%9C%8B%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="从BlocksKit看动态代理/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <blockquote>
<p>你试过倒立或者跑起来看周围的世界吗？</p>
</blockquote>
<hr>
<h1 id="amp-引子"><a href="#amp-引子" class="headerlink" title="&amp; 引子"></a>&amp; 引子</h1><p>之前写过一些源码分析的文章，例如<a href="http://thinker-lj.com/%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%B9%8BAFNetworking/" target="_blank" rel="noopener">AFNetworking</a>这篇大概敲了两万多字，花了差不多工作之余的将近一周时间。外加在团队内做了分享，算下来的时间投入是个不小的数字。当然，这个时间值得投入，可在我看来，并没有利用到最大化。<a href="https://zh.wikipedia.org/wiki/%E5%B8%95%E9%9B%B7%E6%89%98%E6%B3%95%E5%88%99" target="_blank" rel="noopener">帕雷托法则（二八定律）</a>告诉我们80%的结果取决于20%的原因，我相信很多经典的开源库可以做到字字珠玑，但是真正核心的内容和思想精髓还是那需要花费我们80%的时间去体会的那20%！因此，我做了一个重要的决定：再写源码分析的文章，不再面面俱到，具体细节会在开源的源码注释中体现，这里我只需要表达出来通过阅读源码后的真正印象深刻的，残留在脑海中的，内化后的感受就可以了。下面，就以此篇做个尝试……</p>
<hr>
<h1 id="amp-走马观花"><a href="#amp-走马观花" class="headerlink" title="&amp; 走马观花"></a>&amp; 走马观花</h1><p>在iOS的开源社区五千多的 star ，<a href="https://github.com/zwaldowski/BlocksKit" target="_blank" rel="noopener">BlocksKit</a>其实算不上特别著名。之所以注意到它，是在前段时间研究 <strong>Block</strong> 的内部实现时，成了延伸阅读，竟然发现还很有趣。它为很多常用类提供了更加便捷和友好的附带block参数的接口，当然这部分实现很简单，简单举个例子：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">NSArray</span> *)bk_map:(<span class="keyword">id</span> (^)(<span class="keyword">id</span> obj))block &#123;</span><br><span class="line">	<span class="built_in">NSParameterAssert</span>(block != <span class="literal">nil</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">NSMutableArray</span> *result = [<span class="built_in">NSMutableArray</span> arrayWithCapacity:<span class="keyword">self</span>.count];</span><br><span class="line">	[<span class="keyword">self</span> enumerateObjectsUsingBlock:^(<span class="keyword">id</span> obj, <span class="built_in">NSUInteger</span> idx, <span class="built_in">BOOL</span> *stop) &#123;</span><br><span class="line">		<span class="keyword">id</span> value = block(obj) ?: [<span class="built_in">NSNull</span> null];</span><br><span class="line">		[result addObject:value];</span><br><span class="line">	&#125;];</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这是个为集合类型提供类似 map 高阶函数的接口，内部直接调用了系统 API ，在合适的地方执行block即可；源码中大部分的实现都类似这种处理策略，唯有针对代理的处理方式让人眼前一亮，这便是这个库的核心了！
          <div class="post-more-link text-center">
            <a class="btn" href="/%E4%BB%8EBlocksKit%E7%9C%8B%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


      
    
      
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/ATS%E9%99%90%E5%88%B6%E4%B8%8B%E7%9A%84HTTPS%E6%94%B9%E9%80%A0/" itemprop="url">
                  ATS 限制下的 HTTPs 改造
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-12-12T20:25:49+08:00" content="2016-12-12">
              2016-12-12
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF%E5%AE%9E%E8%B7%B5/" itemprop="url" rel="index">
                    <span itemprop="name">技术实践</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/ATS%E9%99%90%E5%88%B6%E4%B8%8B%E7%9A%84HTTPS%E6%94%B9%E9%80%A0/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="ATS限制下的HTTPS改造/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p><img src="/images/14815464969586.jpg" alt=""><br>图片来源于Google</p>
<hr>
<blockquote>
<p>明天总会到来，又总会与今天有所不同…</p>
</blockquote>
<hr>
<h1 id="amp-引子"><a href="#amp-引子" class="headerlink" title="&amp; 引子"></a>&amp; 引子</h1><p>首先说明，这不是一篇 HTTPs 的科普文，有这个需求的朋友，<strong>Google</strong>一下是捷径。本文要讨论的重点是，在AppStore关于<strong>ATS</strong>新规的倒逼下，<strong>iOS</strong>端（大部分实践<strong>Android</strong>端同样适用）是如何一步步全面切换到 HTTPs 的。另外，强调个观念，无论Apple针对ATS的审核是否真正严厉，至少 HTTPs 已经不再是“大势所趋”，可能用“迫在眉睫”更合适了…</p>
<hr>
<h1 id="amp-步步为营"><a href="#amp-步步为营" class="headerlink" title="&amp; 步步为营"></a>&amp; 步步为营</h1><p>这个课题的终极目标很清晰：2017年到来之前，全面完成 HTTPs 的改造。拆解成小目标，主要通过以下几个步骤落地：</p>
<h2 id="amp-amp-一、域名梳理"><a href="#amp-amp-一、域名梳理" class="headerlink" title="&amp;&amp; 一、域名梳理"></a>&amp;&amp; 一、域名梳理</h2><p>项目工程初期的规划是否具有前瞻性以及域名规范标准的执行程度，决定了这个步骤的工作量。可以尝试使用<strong>grep</strong>或者<strong>awk</strong>等文本处理工具跑一遍工程中的<strong>HTTP</strong>字段，这个触目惊心的结果比任何空谈项目规范的教化都会更加印象深刻。最后通过脚本处理，进一步将工程中涉及的上千个请求归类成如下结果：</p>
<table>
<thead>
<tr>
<th align="center">域名类别</th>
<th align="center">描述</th>
<th align="center">特点</th>
</tr>
</thead>
<tbody><tr>
<td align="center">线上责任域名</td>
<td align="center">责任归属本部门的线上环境域名</td>
<td align="center">整个工程涉及最多的请求 改造重点</td>
</tr>
<tr>
<td align="center">线下责任域名</td>
<td align="center">责任归属本部门的线下环境域名</td>
<td align="center">大多已废弃 改造相对轻松</td>
</tr>
<tr>
<td align="center">间接责任域名</td>
<td align="center">责任归属外部门的域名</td>
<td align="center">涉及请求分散 沟通成本高</td>
</tr>
<tr>
<td align="center">第三方责任域名</td>
<td align="center">责任归属三方SDK的域名</td>
<td align="center">升级或替换组件 终极方案白名单</td>
</tr>
<tr>
<td align="center">这个粗略责任归类，目的是细化子任务让更多的人参与进来，并行推进。域名归类中还有个细节，项目中（尤其pod库中的三方组件）存在大量注释的HTTP请求，推测提交审核的门槛不会是粗暴地做HTTP过滤，更大的可能是对ATS开关的检测。所以，对这类HTTP请求，三方组件中的保持不变，自己项目中的视情况，尽量清除，这样便于后续问题的排查和定位。
          <div class="post-more-link text-center">
            <a class="btn" href="/ATS%E9%99%90%E5%88%B6%E4%B8%8B%E7%9A%84HTTPS%E6%94%B9%E9%80%A0/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


      
    
      
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/%E4%BB%8E%E5%BE%AE%E4%BF%A1%E8%AF%BB%E4%B9%A6%E9%82%80%E6%88%91%E5%86%85%E6%B5%8B%E5%88%B0TestFlight/" itemprop="url">
                  从微信读书邀我内测到TestFlight
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-10-20T21:00:31+08:00" content="2016-10-20">
              2016-10-20
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/%E8%A1%8C%E4%B8%9A%E6%B5%AA%E6%BD%AE/" itemprop="url" rel="index">
                    <span itemprop="name">行业浪潮</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/%E4%BB%8E%E5%BE%AE%E4%BF%A1%E8%AF%BB%E4%B9%A6%E9%82%80%E6%88%91%E5%86%85%E6%B5%8B%E5%88%B0TestFlight/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="从微信读书邀我内测到TestFlight/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p><img src="/images/image001.jpg" alt=""><br>美图是一个朋友贡献的，她说看了会觉得温暖。我好奇试了试，果然，废话！因为有太阳…</p>
<hr>
<blockquote>
<p>做成一件事并不难，难的是如何更加优雅的做事…</p>
</blockquote>
<hr>
<h1 id="amp-引爆点"><a href="#amp-引爆点" class="headerlink" title="&amp; 引爆点"></a>&amp; 引爆点</h1><p>最近一段时间喜欢上了微信读书，因为它有个如上图一样温暖的功能：书中自有黄金屋（读书时长换钱买新书）！这在极大满足我成就感的同时，让我在读书这件事上，有了更加可见的短期效益。额，不要误会，不是软文，下面聊正事儿！<br>今天微信读书突然多了个参与内测的入口，点进去玩了一下，走进了<strong>TestFlight</strong>，忽然勾起了我聊聊iOS内测的冲动…</p>
<hr>
<h1 id="amp-黑白之间"><a href="#amp-黑白之间" class="headerlink" title="&amp; 黑白之间"></a>&amp; 黑白之间</h1><p>这个title装了个X，其实就是要先聊下灰度发布。严格来讲，灰度和内测并不对等。前者的范围和涉及的深度都是内测分发无法相提并论的。或者说，内测分发也是灰度发布的支流，闻名的A/B test 也属于灰度的范畴。所以，这里提到灰度发布，也是因为我们在讨论的，就是灰度发布的一种优雅表现形式。
          <div class="post-more-link text-center">
            <a class="btn" href="/%E4%BB%8E%E5%BE%AE%E4%BF%A1%E8%AF%BB%E4%B9%A6%E9%82%80%E6%88%91%E5%86%85%E6%B5%8B%E5%88%B0TestFlight/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


      
    
      
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/%E6%88%91%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E6%85%8E%E9%87%8D%E4%BD%BF%E7%94%A8%E5%8D%95%E4%BE%8B/" itemprop="url">
                  为什么要慎重使用单例
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-09-25T21:58:05+08:00" content="2016-09-25">
              2016-09-25
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/%E8%AE%BE%E8%AE%A1%E5%AE%9E%E7%8E%B0/" itemprop="url" rel="index">
                    <span itemprop="name">设计实现</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/%E6%88%91%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E6%85%8E%E9%87%8D%E4%BD%BF%E7%94%A8%E5%8D%95%E4%BE%8B/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="我为什么要慎重使用单例/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p><img src="/images/IMG_0499.jpg" alt="家在武夷山附近的同事家的蓝天(与主题有关)"><br>家在武夷山附近的基友说，这是他们家的蓝天…</p>
<hr>
<blockquote>
<p>达到某种目的有很多种方式，但会不会目的本身就是错的？</p>
</blockquote>
<hr>
<h1 id="amp-引子"><a href="#amp-引子" class="headerlink" title="&amp; 引子"></a>&amp; 引子</h1><p><strong>手里拿着锤子，看什么都像钉子！</strong>我想每个在coding同时持续learning的人都会经历过这种走火入魔的状态。多人合作开发时，总会需要模块间传值桥接，这时为图方便时常会听到一句话：算了吧，粗暴点，我给你搞个单例吧！需求愉快的做完了，但坑也就此埋下了…<br>自从<strong>GCD</strong>引入以后，单例一般都这么来写了：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="keyword">instancetype</span>)sharedInstance</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">id</span> sharedInstance;</span><br><span class="line">    <span class="comment">// Xcode 居然给 "Dispatch Once" 搞了个默认代码片段</span></span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> once;</span><br><span class="line">    <span class="built_in">dispatch_once</span>(&amp;once, ^&#123;</span><br><span class="line">        sharedInstance = [[<span class="keyword">self</span> alloc] init];</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> sharedInstance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实现简单，并非意味着可以肆无忌惮。单例纵使有千般好，今天全不提，我们下面讨论滥用的危害。</p>
<hr>
<h1 id="amp-病态的单例"><a href="#amp-病态的单例" class="headerlink" title="&amp; 病态的单例"></a>&amp; 病态的单例</h1><h2 id="amp-amp-全局状态的问题"><a href="#amp-amp-全局状态的问题" class="headerlink" title="&amp;&amp; 全局状态的问题"></a>&amp;&amp; 全局状态的问题</h2><p>单例不仅唯一而且是<strong>全局状态</strong>，显然太多的全局状态，是程序设计首先要规避的问题。</p>
<h3 id="amp-amp-amp-场景一"><a href="#amp-amp-amp-场景一" class="headerlink" title="&amp;&amp;&amp; 场景一"></a>&amp;&amp;&amp; 场景一</h3><p>考虑下面这个场景：假如我把图片下载管理类设计成单例，现在有两个入口，入口A需要对图片进行某种规格的压缩，而入口B需要另外一种不同于A的压缩。如果两个入口在App的一个生命周期内都被触发过，那后者的设置就把前者<strong>覆盖</strong>掉了，换句话说，因为这种全局状态同一时间只会使一种配置生效。显然这种全局状态不仅没必要而且会造成难以调试的奇怪<strong>bug</strong>。</p>
          <div class="post-more-link text-center">
            <a class="btn" href="/%E6%88%91%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E6%85%8E%E9%87%8D%E4%BD%BF%E7%94%A8%E5%8D%95%E4%BE%8B/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


      
    
      
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/%E4%BB%8E%E6%95%B0%E6%8D%AE%E5%BA%93%E8%B0%88%E9%87%8D%E6%9E%84/" itemprop="url">
                  一次Crash引发的持久层重构
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-09-05T23:15:44+08:00" content="2016-09-05">
              2016-09-05
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/%E8%AE%BE%E8%AE%A1%E5%AE%9E%E7%8E%B0/" itemprop="url" rel="index">
                    <span itemprop="name">设计实现</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/%E4%BB%8E%E6%95%B0%E6%8D%AE%E5%BA%93%E8%B0%88%E9%87%8D%E6%9E%84/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="从数据库谈重构/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p><img src="/images/%E5%8C%97%E6%88%B4%E6%B2%B3.jpg" alt="摄于前几日的北戴河之行(与主题有关)"><br>在北戴河，看到这番层次分明的美景，我脑海里出现了下面要聊的数据库重构…</p>
<hr>
<blockquote>
<p>事不过三，三则重构！</p>
</blockquote>
<hr>
<h1 id="amp-背景与痛点"><a href="#amp-背景与痛点" class="headerlink" title="&amp; 背景与痛点"></a>&amp; 背景与痛点</h1><p>这事儿说来真的话长！很久很久以前，为了保证数据库操作的线程安全，所有操作都放在了主线程，最终，我们这些个小年轻儿忍不了，重构了…<br>重构最终如火如荼搞完了，但还是年轻，虽然使用了FMDB的内置<strong>串行队列</strong>管理数据库操作，效果也很明显，消息流快的飞起来！但是，偶尔莫名奇妙的crash，给我们泼了一盆冷水…<br>最终，团队中一个妹子没事儿看代码玩儿，发现了其中的问题，要不说 还是妹子心细啊！其实原因很简单，由于历史遗留问题，外部对数据库的调用，存在多个初始化操作，这样虽然串行队列有了，但是却有多个队列绑定到了多个对象上，所以<strong>crash</strong>是自然的了。<br>上面说了半天，就是下图描述的问题：<br><img src="/images/14732600573869.jpg" alt=""></p>
<p><strong>因此，我们又走上了重构之路！</strong>
          <div class="post-more-link text-center">
            <a class="btn" href="/%E4%BB%8E%E6%95%B0%E6%8D%AE%E5%BA%93%E8%B0%88%E9%87%8D%E6%9E%84/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


      
    
      
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/%E3%80%8A%E4%B8%89%E5%B0%91%E7%88%B7%E7%9A%84%E5%89%91%E3%80%8B%E7%BC%BA%E5%B0%91%E4%BA%86%E4%BB%80%E4%B9%88/" itemprop="url">
                  《三少爷的剑》缺少了什么
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-08-20T20:09:12+08:00" content="2016-08-20">
              2016-08-20
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/%E5%81%87%E8%A3%85%E6%96%87%E8%89%BA/" itemprop="url" rel="index">
                    <span itemprop="name">假装文艺</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/%E3%80%8A%E4%B8%89%E5%B0%91%E7%88%B7%E7%9A%84%E5%89%91%E3%80%8B%E7%BC%BA%E5%B0%91%E4%BA%86%E4%BB%80%E4%B9%88/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="《三少爷的剑》缺少了什么/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p><img src="/images/IMG_0584.jpg" alt=""><br>豆瓣上一张跟三少爷没有半毛钱关系的图；不过，我要表达的都在这里了…</p>
<hr>
<blockquote>
<p>　剑气纵横三万里，一剑光寒十九洲</p>
</blockquote>
<hr>
<h1 id="amp-是套路还是风格"><a href="#amp-是套路还是风格" class="headerlink" title="&amp; 是套路还是风格"></a>&amp; 是套路还是风格</h1><p>什么儿女情长，什么江湖恩怨，故事开局的杀、杀、杀，踏入江湖的无名剑客，好像总是带着仇恨。而江湖又从来险恶，可还是会遇到一心求胜的执拗侠客、身不由己的风尘女子、道貌岸然的武林豪杰、穷困孤苦的可怜人家…最后又总会大道得悟，你觉得他要更进一步，一统江湖的时候，他又总会厌倦，职业生涯戛然而止，从此江湖只留下他的传闻…<br>就是这种感觉，明明知道它是深深的套路，我宁愿捧为风格；是的，我喜欢武侠，喜欢它的悬念？喜欢它的人物反转？喜欢它的江湖气息？或许只是因为那个世界与我的生活不同。可后来，渐渐长大，也不知道是懂事了，还是糊涂了，居然从某一天开始，忽然就有了洞悉一切江湖恩怨的超能力：那里和禁锢我的现实世界，并没什么本质区别。尤其是开始写代码之后，更加觉得自己是个骨骼清奇的剑客，也不知道是因为胆子小还是资质不够，至今倒还没有剑走偏锋！</p>
<hr>
<h1 id="amp-这不是我要的三少爷"><a href="#amp-这不是我要的三少爷" class="headerlink" title="&amp; 这不是我要的三少爷"></a>&amp; 这不是我要的三少爷</h1><p>听说徐老怪要拍《三少爷的剑》，最近抽空重读原著，找找当年的感觉，才有了这篇“假装文艺”。小时候主要感兴趣的其实更多是“剑”，这次重点在理解三少爷上面，可最后却欣赏起燕十三来…<br>我印象最深刻的，三少爷最后削去了双手的大拇指，为的是远离江湖纷争？！试想，一个高端黑客为了结束自己的职业生涯，远离键盘，效仿一下三少爷…纷乱江湖食物链顶层的三少爷，心智居然这般稚嫩，这样的状态，是怎么放下江湖的？我真的不喜欢三少爷，不止是因为他不装逼、不炫技，不敢爱、不敢恨，你可以不潇洒，可你又不优雅！
          <div class="post-more-link text-center">
            <a class="btn" href="/%E3%80%8A%E4%B8%89%E5%B0%91%E7%88%B7%E7%9A%84%E5%89%91%E3%80%8B%E7%BC%BA%E5%B0%91%E4%BA%86%E4%BB%80%E4%B9%88/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


      
    
      
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/%E5%85%B3%E4%BA%8E%E7%AC%AC%E4%B8%89%E6%96%B9%E5%B9%B3%E5%8F%B0%E5%B0%81%E8%A3%85/" itemprop="url">
                  造个分享的轮子
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-08-03T23:34:43+08:00" content="2016-08-03">
              2016-08-03
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/%E8%AE%BE%E8%AE%A1%E5%AE%9E%E7%8E%B0/" itemprop="url" rel="index">
                    <span itemprop="name">设计实现</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/%E5%85%B3%E4%BA%8E%E7%AC%AC%E4%B8%89%E6%96%B9%E5%B9%B3%E5%8F%B0%E5%B0%81%E8%A3%85/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="关于第三方平台封装/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p><img src="/images/IMG_0283.jpg" alt="摄于前几日的草原之行(与主题有关)"><br>朋友分享的他们家的黄昏…</p>
<hr>
<blockquote>
<p>软件架构绝不是框架的堆砌，二次封装到底是局限还是延伸，全看功力。</p>
</blockquote>
<hr>
<h1 id="amp-背景与痛点"><a href="#amp-背景与痛点" class="headerlink" title="&amp; 背景与痛点"></a>&amp; 背景与痛点</h1><p> 资本市场操控的互联网，不会有单纯只为让你提高技术的需求。所以没有天时地利人和，很难碰到造轮子的良机。<br> 最近，运气不错，赶上对各大通用组件大刀阔斧的重构；今天，单聊分享。<br>之前项目快速迭代，针对分享使用了<a href="http://www.mob.com/#/" target="_blank" rel="noopener">ShareSDK</a>（毕竟当初满足了我们的刚需，帮助宣传一下吧！体验还不错）。最后既然决定重复造轮子，主要有以下几点考虑：</p>
<ul>
<li>跟不上更新节奏，向下兼容很难面面俱到。（毕竟大家都需要重构，可以理解）</li>
<li>排雷填坑，需要外界力量，这让傲骄的我们很不爽。（主要客服不是妹子）</li>
<li>臃肿！每次pod都要搞很久。（在满足业务需求的基础上，我们很自信可以搞的小而美）</li>
<li>除了我们想要的功能，他们还干了什么，我们真不知道了。（真心害怕啊）</li>
</ul>
<p><strong>总之，重构可不是一言不合就敢去搞的事情！</strong>
          <div class="post-more-link text-center">
            <a class="btn" href="/%E5%85%B3%E4%BA%8E%E7%AC%AC%E4%B8%89%E6%96%B9%E5%B9%B3%E5%8F%B0%E5%B0%81%E8%A3%85/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


      
    
      
    
      
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/Swift%E4%B9%8B%E9%9D%A2%E5%90%91%E5%8D%8F%E8%AE%AE%E7%BC%96%E7%A8%8B/" itemprop="url">
                  Swift之面向协议编程
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-06-18T19:59:29+08:00" content="2016-06-18">
              2016-06-18
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Swift/" itemprop="url" rel="index">
                    <span itemprop="name">Swift</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/Swift%E4%B9%8B%E9%9D%A2%E5%90%91%E5%8D%8F%E8%AE%AE%E7%BC%96%E7%A8%8B/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="Swift之面向协议编程/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <blockquote>
<p>Swift 就是一个面向协议的编程语言。 —— Dave Abrahams</p>
</blockquote>
<hr>
<h1 id="amp-引子"><a href="#amp-引子" class="headerlink" title="&amp; 引子"></a>&amp; 引子</h1><p>在去年的 <strong>WWDC</strong>，Dave Abrahams 有个非常具有影响力并让人大开眼界的布道，主要内容就是基于 Swift 的面向协议编程。在接触 Swift 这段时间，也确实发现正如这位教授所说，Swift简直就是个面向协议的编程语言。在这门语言的标准库中有着大量的协议身影。既然 Swift 的构造基石都是这样，那我们有必要思考下这样做到底能带来什么。虽然在工业级项目中我和大多数iOS开发者一样，仍然在使用 <strong>Objective-C</strong>，面向对象编程的事件，每天都在发生着，但 Swift 天然具有的这种面向协议编程（我们姑且叫它 <strong>POP</strong> 吧）特性，给我们打开了一扇门，代码还可以这样写……</p>
<hr>
<h1 id="amp-硬生生的栗子"><a href="#amp-硬生生的栗子" class="headerlink" title="&amp; 硬生生的栗子"></a>&amp; 硬生生的栗子</h1><p>毕竟没在工业级项目中使用 Swift 的经验，只好生造个栗子，不过结合了常见场景，足以阐述问题。在之前的一个项目中遇到这样一种场景：一个发布动态按钮，需要通过抖动和间歇缩放来提醒用户，也算是个用户引导吧。那我们先用 Objective-C 实现一个不经思考的版本：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">XXViewController</span></span></span><br><span class="line">- (<span class="keyword">void</span>)shakeAndZoom &#123;</span><br><span class="line">	<span class="comment">// 具体实现</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>很快，PM 发现这个效果还不错，她决定应用到其他的需求中，这当然难不倒我们，那就直接用 Category 实现吧，以后再有类似需求，拿来直接用。于是重构成了这样：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">UIButton</span>(<span class="title">shakeAndZoom</span>)</span></span><br><span class="line">- (<span class="keyword">void</span>)shakeAndZoom &#123;</span><br><span class="line">	<span class="comment">// 具体实现</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">XXViewController</span></span></span><br><span class="line">- (<span class="keyword">void</span>)shakeAndZoom &#123;</span><br><span class="line">	[_btn shakeAndZoom];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>以上简化了具体了实现，这应该是在具体项目中，我们经常会碰到的场景了。其实还可以再延伸一步，PM 如果要求不只是按钮的效果，扩大效果范围呢？那也难不倒我们，把实现放到 UIView 的 Category 下面就好了。毕竟，作为有追求有代码洁癖的有志码农，我们决不允许重复代码的出现。
          <div class="post-more-link text-center">
            <a class="btn" href="/Swift%E4%B9%8B%E9%9D%A2%E5%90%91%E5%8D%8F%E8%AE%AE%E7%BC%96%E7%A8%8B/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


      
    
      
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%B9%8BSDWebImage/" itemprop="url">
                  源码解析之SDWebImage
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-05-26T15:02:53+08:00" content="2016-05-26">
              2016-05-26
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/" itemprop="url" rel="index">
                    <span itemprop="name">源码解析</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%B9%8BSDWebImage/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="源码解析之SDWebImage/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <blockquote>
<p>Asynchronous image downloader with cache support as a UIImageView category</p>
</blockquote>
<hr>
<h1 id="amp-引子"><a href="#amp-引子" class="headerlink" title="&amp; 引子"></a>&amp; 引子</h1><p>“一个支持缓存的异步下载图片的UIImageView分类”,这是SDWebImage官方的相当保守的自我描述；<br>看完下图，就可以了解作者有多么的谦虚；<br>下图我旨在表现SDWebImage的清晰的模块划分和任务分级策略，并不能全面的涵盖它的一切。<br><img src="/images/14695977227412.jpg" alt="SDWebImage 模块划分与任务分级"></p>
<p>从标题就可以知晓，如果你只是想了解SDWebImage的用法，那最好直接去看<a href="https://github.com/rs/SDWebImage/blob/master/README.md" target="_blank" rel="noopener">README.md</a>;<br>下面我会按照任务分级和模块划分，从以下几个方面抽丝剥茧：</p>
<hr>
<h1 id="amp-Cache-缓存管理"><a href="#amp-Cache-缓存管理" class="headerlink" title="&amp; Cache -缓存管理"></a>&amp; Cache -缓存管理</h1><p>内存缓存和磁盘都由<strong>SDImageCache</strong>处理，即有关图片缓存的一切，都封装在这个类里了；</p>
<h2 id="amp-amp-一-整体流程"><a href="#amp-amp-一-整体流程" class="headerlink" title="&amp;&amp; 一 整体流程"></a>&amp;&amp; 一 整体流程</h2><ul>
<li>缓存命中流程：<ol>
<li>通过外部传入的key，首先检查是否命中内存缓存，命中则直接返回；</li>
<li>检查是否命中磁盘缓存，未命中则返回；</li>
<li>命中磁盘缓存，检查是否开启内存缓存，开启则设置内存缓存，并返回命中结果；</li>
</ol>
</li>
</ul>
<h2 id="amp-amp-二-内存缓存"><a href="#amp-amp-二-内存缓存" class="headerlink" title="&amp;&amp; 二 内存缓存"></a>&amp;&amp; 二 内存缓存</h2><p>先来说内存缓存，就像<a href="https://github.com/AFNetworking/AFNetworking" target="_blank" rel="noopener">AFN</a>作者所说，<a href="http://nshipster.cn/nscache/" target="_blank" rel="noopener">NSCache</a>就可以处理一切你想要的了；SDImageCache内部的<strong>memCache</strong>是一个<strong>NSCache</strong>对象，因此直接通过<strong>- setObject:forKey:</strong>就可以设置缓存，但是作者使用了<strong>- setObject:forKey:cost:</strong>，用意是通过<strong>const</strong>来向系统传递单一缓存大小，从而通过系统对整个缓存大小的控制，有效控制整个缓存的容量。但是，这就是NSCache最坑的地方，你永远也无法知道，当缓存到达你设置的临界时，到底是哪部分缓存被清除了（清除也有可能不是立即进行的）。瑕不掩瑜吧，看来作者也并没因此放弃对NSCache的使用。另外，提到const，作者提供了一个计算图片大小的方法，很精简，直接贴出来：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">FOUNDATION_STATIC_INLINE <span class="built_in">NSUInteger</span> SDCacheCostForImage(<span class="built_in">UIImage</span> *image) &#123;</span><br><span class="line">    <span class="keyword">return</span> image.size.height * image.size.width * image.scale * image.scale;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 其实这个方法计算出来的并不是图片所占字节数，而是像素点，SDWebImage官方也在<a href="https://github.com/rs/SDWebImage/issues/1369" target="_blank" rel="noopener">此处</a>进行了说明；所以，如果要计算图片所占的大小，可以这样做：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 延续作者的思路</span></span><br><span class="line">image.size.height * image.size.width * image.scale * image.scale * <span class="built_in">CGImageGetBitsPerPixel</span>(image.CGImage) / CHAR_BIT</span><br><span class="line"><span class="comment">// 更简洁的方式</span></span><br><span class="line"><span class="built_in">CGImageGetBytesPerRow</span>(image.CGImage) * <span class="built_in">CGImageGetHeight</span>(image.CGImage)</span><br></pre></td></tr></table></figure>
<p>以上都是题外话，因为这个计算方法只用在了内存缓存，上面也提到了NSCache的坑，所以此处，这个值也就无所谓了。<br>另外，关于内存缓存删除的触发，除了NSCache的自动处理外（这部分毕竟是不可控的），作者还监听了<strong>UIApplicationDidReceiveMemoryWarningNotification</strong>做了更加保险的处理。</p>
<h2 id="amp-amp-三-磁盘缓存"><a href="#amp-amp-三-磁盘缓存" class="headerlink" title="&amp;&amp; 三  磁盘缓存"></a>&amp;&amp; 三  磁盘缓存</h2><p>较之内存缓存成熟的NSCache方案，磁盘缓存要相对复杂一些了；<br>因为作者旨在实现的是一个图片缓存管理，相对来说，图片属于大容量对象存储。因此，这里作者直接使用文件存储这种方式，而不是像其他缓存策略那样，数据库和文件并用，也是合理的。</p>
<ol>
<li><p>存储<br> 存储部分，剖去外层一系列的判断，最终会调用下面的方法：  </p>
 <figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)storeImageDataToDisk:(<span class="built_in">NSData</span> *)imageData forKey:(<span class="built_in">NSString</span> *)key &#123;</span><br><span class="line">    <span class="keyword">if</span> (!imageData) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (![_fileManager fileExistsAtPath:_diskCachePath]) &#123;</span><br><span class="line">        [_fileManager createDirectoryAtPath:_diskCachePath withIntermediateDirectories:<span class="literal">YES</span> attributes:<span class="literal">nil</span> error:<span class="literal">NULL</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// get cache Path for image key</span></span><br><span class="line">    <span class="built_in">NSString</span> *cachePathForKey = [<span class="keyword">self</span> defaultCachePathForKey:key];</span><br><span class="line">    <span class="comment">// transform to NSUrl</span></span><br><span class="line">    <span class="built_in">NSURL</span> *fileURL = [<span class="built_in">NSURL</span> fileURLWithPath:cachePathForKey];</span><br><span class="line">    [_fileManager createFileAtPath:cachePathForKey contents:imageData attributes:<span class="literal">nil</span>];</span><br><span class="line">    <span class="comment">// disable iCloud backup</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.shouldDisableiCloud) &#123;</span><br><span class="line">        [fileURL setResourceValue:[<span class="built_in">NSNumber</span> numberWithBool:<span class="literal">YES</span>] forKey:<span class="built_in">NSURLIsExcludedFromBackupKey</span> error:<span class="literal">nil</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 贴出这个方法，是为了说明，作者并没有在每次的磁盘缓存中去做缓存容量和时间的判断，而是很粗暴的进行了文件存储。<br> 为什么会这么做？所有对磁盘缓存的操作，都放在了<strong>ioQueue</strong>这个串行队列中，试想，如果每次存储都做缓存时效和空间大小的判断和处理，那这个存储效率就太低了，同时缓存的维护代价会变得非常大。当然，外部设置的缓存时效和空间限制也并不是形同虚设，稍后会在缓存清理中做解释。</p>
</li>
<li><p>缓存清理<br>先解释上面的问题，缓存清理会在应用进入后台和应用即将被终止时进行。<br>因为作者监听了<strong>UIApplicationDidEnterBackgroundNotification</strong> 和 <strong>UIApplicationWillTerminateNotification</strong>这两个通知。<br>这两个通知，最终都会调用<strong>cleanDiskWithCompletionBlock</strong>方法，这个方法是整个缓存管理类营养价值最高的地方。由于代码量过大，这里就不贴出来了。下面提几个关键点：</p>
<ul>
<li>缓存清除策略:时间维度(优先考虑过期时间)和空间维度(LRU逐步衰减)；</li>
<li>清理工作不会立即进行，考虑I/O阻塞和数组遍历修改易crash等因素，待清除对象最后统一处理。</li>
<li>采用LRU,而非LFU的原因：文件缓存天然具有修改时间监控优势，这种实现方式维护成本更低。</li>
</ul>
</li>
</ol>
          <div class="post-more-link text-center">
            <a class="btn" href="/%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%B9%8BSDWebImage/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


      
    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">&lt;i class=&quot;fa fa-angle-right&quot;&gt;&lt;&#x2F;i&gt;</a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="//schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/logo.png"
               alt="thinker-lj" />
          <p class="site-author-name" itemprop="name">thinker-lj</p>
          <p class="site-description motion-element" itemprop="description">一个很会写代码的伪文艺青年</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">21</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              
                <span class="site-state-item-count">9</span>
                <span class="site-state-item-name">分类</span>
              
            </div>
          

          
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">35</span>
                <span class="site-state-item-name">标签</span>
              
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">thinker-lj</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io" target="_blank" rel="noopener">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next" target="_blank" rel="noopener">
    NexT.Mist
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.2"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.2"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"thinker-lj"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  






  
  

  

  

  

  


</body>
</html>
