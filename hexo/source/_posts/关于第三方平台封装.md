---
title: 造个分享的轮子
date: 2016-08-03 23:34:43
tags:
categories: [设计实现]
---

![摄于前几日的草原之行(与主题有关)](/images/IMG_0283.jpg)
朋友分享的他们家的黄昏…

-------

> 软件架构绝不是框架的堆砌，二次封装到底是局限还是延伸，全看功力。

-------

# & 背景与痛点
 资本市场操控的互联网，不会有单纯只为让你提高技术的需求。所以没有天时地利人和，很难碰到造轮子的良机。
 最近，运气不错，赶上对各大通用组件大刀阔斧的重构；今天，单聊分享。
之前项目快速迭代，针对分享使用了[ShareSDK](http://www.mob.com/#/)（毕竟当初满足了我们的刚需，帮助宣传一下吧！体验还不错）。最后既然决定重复造轮子，主要有以下几点考虑：

* 跟不上更新节奏，向下兼容很难面面俱到。（毕竟大家都需要重构，可以理解）
* 排雷填坑，需要外界力量，这让傲骄的我们很不爽。（主要客服不是妹子）
* 臃肿！每次pod都要搞很久。（在满足业务需求的基础上，我们很自信可以搞的小而美）
* 除了我们想要的功能，他们还干了什么，我们真不知道了。（真心害怕啊）

**总之，重构可不是一言不合就敢去搞的事情！**<!-- more -->

-------

# & 调研与思考
决定做这件事，其实需要很大的勇气。引入多个三方平台，进行二次封装，这需要足够的耐心去踩遍各个平台的坑。
深入每个平台后发现，仅仅针对分享功能，各个平台当然在实现思路上大同小异，但是细节及API着实体现了程序员们的个性了。整个调研过程，主要在验证和思考以下几个问题：
1. 接口调用 vs SDK
显然直接调研各平台开发的HTTP/HTTPS接口，是最容易做到小而美的封装的。但是，每个平台对分享功能的接口支持力度千差万别，更大的折磨是接口的更新又如何及时获取…所以，最终我们选择了各个平台建议的SDK方案，没有在这上面过度逞能！
2. 业务层接口统一 vs 各平台映射
上面提到，同样的功能，不同平台的API不同。这时就要考虑，最终暴露给业务层的接口是要统一规范还是由各平台逐级向外映射。两者各有千秋，接口统一有利于内部结果的隐藏，使得调用者不必去考虑太多平台相关性；后者则结构更加清晰，有利于后期单一平台的调整和问题排查。可是，傲娇的我们，就要做到两者兼具！
3. 内置UI vs 自定义UI
你能想象，折腾半天，最终的分享功能没有UI吗？但是，更不能接受的是改UI，还要去动整个分享框架吧！最终，我们的策略是，实现一套默认UI，同时提供UI层的扩展和自定义。
4. UIImage vs URL
说白了就是内部是否支持图片下载功能。在这点上，和团队的旺仔讨论了很久，最终为了保持分享框架的干净和专一，内部不提供图片下载，只负责图片数据的条件压缩。不过，这没完，我们会在框架和业务层之间“加壳”，在这一层实现图片下载的统一处理，同时这一层也做了UI的相关处理。

-------

# & 设计和实现
谈设计喜欢先用图说话，下图是整个分享框架的模块结构：
![](/images/第三方分享框架图.png)
## && Core Protocol - 协议层
这一层定义了平台注册服务和分享服务的协议，旨在约束各平台，同时提供统一规范接口；
协议是框架设计中经常用到的处理方式，它与委托虽然都用了**protocol**关键字，但思想和角度不同；协议更强调约束和准则，与类之间独立性更强，委托或者说代理（角度不同）更强调合作，与类绑定性更强；
## && Comply - 实现
这一层是具体平台对协议的支持实现，暂时加入了三个平台（WeChat QQ Weibo），内部细分了朋友圈、空间等小平台。其实本层除了和协议层打交道之外，还调用了图片压缩处理等工具类，图中没有对这些做出标识。
## && Dispatch Manager - 消息派发中心
外部暴露给Shell的就是这个消息派发中心，主要做的工作是通过配置文件，根据传进来的平台类型，将具体的平台信息派发给平台的实现层。注意，这里并没有处理UI层相关事务，因为过度耦合，不利于UI层的自定义。二者的组合，会放到shell中去处理。
## && UI层
UI部分提供了一种默认的实现-底部动画弹出，同时支持平台位置和数量以及各平台文案logo更换。这里设置了按钮点击的代理，最终会抛给shell层实现，去调用消息派发中心处理。
## && Shell层
图中并没有指出这部分，因为它是分享框架上层的一层封装。请允许我叫它shell，它和Linux系统的shell思路类似。这里是真正和业务层关联的部分，主要处理具体平台的注册，图片下载，UI代理实现，消息分发调用等等。理想的话，后续的需求变更，会主要在这一层修改，不去触碰底层分享框架。

-------

# & 最后
做完这次分享的重构，回头去看，有种清爽的感觉。对比前面提到的第三方分享服务，会发现我们对分享功能有了绝对的控制。三方平台之上的封装，其实很考验功力，将分散的平台聚合，这种聚合又不能操之过急，否则会造成后期修改维护的麻烦，又涉及UI的处理，通过这种层层外抛的处理策略实践，学到了很多设计哲学。

